- name: Get cluster version
  k8s_info:
    api_version: config.openshift.io/v1
    kind: ClusterVersion
    name: version
  register: r_cluster_version

- name: Set ocp4_cluster_version fact
  set_fact:
    ocp4_cluster_version: "{{ r_cluster_version.resources[0].status.history[0].version }}"

- name: Print OpenShift version
  debug:
    msg: "{{ ocp4_cluster_version }}"

#####
## para uma instalacao manual do pipelines e gitops nao foi encontrado os SA gitops-rb.yml.j2
#####
##- name: Add ClusterRoleBinding to the openshift-gitops-controller
##  kubernetes.core.k8s:
##    state: present
##    definition: "{{ lookup('template', 'gitops-rb.yml.j2') }}"
##
#- name: Install ArgoCD
#  k8s:
#    state: present
#    definition: "{{ lookup('template', 'gitops-argocd.yaml.j2') | from_yaml }}"
#
#####
## para uma instalacao manual do pipelines n√£o tem esse CM
#####
#- name: Patch the CM of Openshift GitOps to add role admin by default
#  command: oc patch cm/argocd-rbac-cm -n openshift-gitops --type=merge -p '{"data":{"policy.default":"role:admin"}}'
#
#- name: Add SSO Keycloak in Openshift GitOps by default
#  shell: |
#    oc -n openshift-gitops patch argocd openshift-gitops --type='json' -p='[{"op": "add", "path": "/spec/sso", "value": {"provider": "keycloak"} }]'
#
- name: Get ArgoCD route
  kubernetes.core.k8s_info:
    kind: Route
    api_version: route.openshift.io/v1
    name: openshift-gitops-server
    namespace: "{{ gitops_namespace }}"
  register: r_argo_route
  retries: 10
  delay: 20
  until:
    - r_argo_route.resources[0].spec.host is defined

- name: debug
  debug:
    msg: "{{ r_argo_route.resources[0].spec.host }}"

- name: Get argocd password
  kubernetes.core.k8s_info:
    kind: Secret
    api_version: v1
    name: openshift-gitops-cluster
    namespace: "{{ gitops_namespace }}"
  register: r_argopass

- name: debug
  debug:
    msg: "{{ r_argopass.resources[0].data['admin.password'] }}"

- name: Add CM for ArgoCD env in namespace  "{{ pipeline_namespace }}"
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'gitops-env-cm.yaml.j2') }}"

- name: Add Secrets for ArgoCD env in namespace  "{{ pipeline_namespace }}"
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'gitops-env-secret.yaml.j2') }}"
