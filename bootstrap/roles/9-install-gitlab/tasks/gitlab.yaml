#
#- name: Create OperatorGroup
#  kubernetes.core.k8s:
#    state: present
#    definition: "{{ lookup('template', 'gitlab-operator-group.yaml.j2') }}"
#
#- name: Create Subscription
#  kubernetes.core.k8s:
#    state: present
#    definition: "{{ lookup('template', 'gitlab-subscription.yaml.j2') }}"
#
#- name: Deploy GitLab Custom Resource
#  kubernetes.core.k8s:
#    state: present
#    definition: "{{ lookup('template', 'gitlab-cr.yaml.j2') }}"
#

- name: Wait for route Gitlab with the desired prefix to appear
  until: gitlab_filtered_routes | length > 0
  retries: 40
  delay: 10
  set_fact:
    gitlab_filtered_routes: "{{ gitlab_routes.resources | selectattr('metadata.name', 'search', '^gitlab-webservice-default.*') | list }}"
  vars:
    gitlab_routes: >-
      {{
        (lookup('k8s', kind='Route', api_version='route.openshift.io/v1', namespace={{ gitlab_namespace }}) | list)
        if gitlab_routes is undefined else gitlab_routes
      }}

- name: Print Gitlab Route
  debug:
    msg: "{{ gitlab_routes }}"



- name: Get Gitlab password
  kubernetes.core.k8s_info:
    kind: Secret
    api_version: /v1
    name: gitlab-gitlab-initial-root-password
    namespace: "{{ gitlab_namespace }}"
  register: gitlab_pass

- name: debug
  debug:
    msg: "{{ gitlab_pass.resources[0].data['password'] }}"

- name: Print Gitlab Password
  shell: "echo -n {{ gitlab_pass.resources[0].data['password'] }}  | base64 --decode"
  args:
    executable: /bin/bash
  register: shell_base64

#  oc create route edge rt-cert --service=gitlab-webservice-default --hostname=gitl.apps.cluster-qq995.sandbox2890.opentlc.com --path=/ --port=http-workhorse
