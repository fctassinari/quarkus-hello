#
#- name: Create OperatorGroup
#  kubernetes.core.k8s:
#    state: present
#    definition: "{{ lookup('template', 'gitlab-operator-group.yaml.j2') }}"
#
#- name: Create Subscription
#  kubernetes.core.k8s:
#    state: present
#    definition: "{{ lookup('template', 'gitlab-subscription.yaml.j2') }}"
#
#- name: Deploy GitLab Custom Resource
#  kubernetes.core.k8s:
#    state: present
#    definition: "{{ lookup('template', 'gitlab-cr.yaml.j2') }}"
#

- name: Get all Gitlab routes
  kubernetes.core.k8s_info:
    kind: Route
    api_version: route.openshift.io/v1
    namespace: "{{ gitlab_namespace }}"
  register: gitlab_routes
  until: gitlab_routes | length > 0
  ignore_errors: true
  retries: 30
  delay: 10

- name: Wait for route Gitlab with the desired prefix to appear
  set_fact:
    gitlab_route: "{{ gitlab_routes.resources | selectattr('metadata.name', 'search', '^gitlab-webservice-default.*') | list | first }}"

- name: Get Gitlab password
  kubernetes.core.k8s_info:
    kind: Secret
    api_version: /v1
    name: gitlab-gitlab-initial-root-password
    namespace: "{{ gitlab_namespace }}"
  register: gitlab_pass

- name: Decode base64 Gitlab Password
  shell: "echo -n {{ gitlab_pass.resources[0].data['password'] }}  | base64 --decode"
  register: shell_base64
  args:
    executable: /bin/bash

- name: Print Gitlab Route
  debug:
    msg: "{{ gitlab_route.spec.host }}"

- name: Print Gitlab Password
  debug:
    msg: "{{ shell_base64 }}"

#  oc create route edge rt-cert --service=gitlab-webservice-default --hostname=gitl.apps.cluster-qq995.sandbox2890.opentlc.com --path=/ --port=http-workhorse
